{% extends "base.html" %}

{% block title %}HomeFinder - Admin Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="display-4 mb-4">Admin Dashboard</h1>
        <p class="lead">Manage HomeFinder scraping and database operations.</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Database Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center mb-3">
                            <div class="card-body">
                                <h3 class="card-title">{{ stats.total_properties }}</h3>
                                <p class="card-text">Total Properties</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center mb-3">
                            <div class="card-body">
                                <h3 class="card-title">€{{ "%.2f"|format(stats.average_price) }}</h3>
                                <p class="card-text">Average Price</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center mb-3">
                            <div class="card-body">
                                <h3 class="card-title">{{ "%.0f"|format(stats.average_size) }} m²</h3>
                                <p class="card-text">Average Size</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center mb-3">
                            <div class="card-body">
                                <h3 class="card-title">{% if stats.last_updated %}{{ stats.last_updated }}{% else %}Never{% endif %}</h3>
                                <p class="card-text">Last Updated</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Scrape History</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source</th>
                                <th>Listings Found</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if scrape_history %}
                                {% for scrape in scrape_history %}
                                    <tr>
                                        <td>{{ scrape.timestamp }}</td>
                                        <td><span class="badge bg-{{ 'primary' if scrape.source == 'background' else 'success' if scrape.source == 'manual' else 'info' }}">{{ scrape.source }}</span></td>
                                        <td>{{ scrape.listings_count }}</td>
                                        <td>{{ "%.1f"|format(scrape.duration_seconds) }} seconds</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No scrape history available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Showing last 10 scrape runs. Automatic cleanup keeps maximum 100 entries.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Force Launch Scraping</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Trigger a manual scraping run to update property listings from all supported websites.</p>
                <form action="{{ url_for('main.admin_scrape') }}" method="POST">
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-arrow-clockwise"></i> Launch Scraping Now
                    </button>
                </form>
                <div class="mt-3">
                    <small class="text-muted">This will run in the background and may take several minutes to complete.</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">Remove All Properties</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Permanently delete all properties from the database.</p>
                <form action="{{ url_for('main.admin_clear') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete ALL properties? This cannot be undone!');">
                    <input type="hidden" name="confirm" value="true">
                    <button type="submit" class="btn btn-danger btn-lg w-100">
                        <i class="bi bi-trash"></i> Delete All Properties
                    </button>
                </form>
                <div class="mt-3">
                    <small class="text-muted">This action is irreversible. All {{ stats.total_properties }} properties will be permanently removed.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">API Endpoints</h5>
            </div>
            <div class="card-body">
                <p>You can also trigger these operations via API:</p>
                <ul>
                    <li><strong>POST /api/scrape</strong> - Trigger manual scraping</li>
                    <li><strong>POST /api/clear</strong> - Clear all properties (requires <code>{"confirm": true}</code>)</li>
                </ul>
                <div class="mt-3">
                    <small class="text-muted">API endpoints require proper authentication in production environments.</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Add any additional JavaScript if needed
</script>
{% endblock %}